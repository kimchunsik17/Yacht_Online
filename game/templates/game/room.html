<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Yacht Room</title>
    <style>
        .dice-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .dice {
            width: 50px;
            height: 50px;
            border: 2px solid black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            background-color: #f0f0f0;
        }
        .dice.kept {
            background-color: lightblue;
            border-color: blue;
        }
        .dice.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #rolls-left {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .scoreboard {
            width: 300px;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .scoreboard th, .scoreboard td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        .scoreboard td.selectable {
            cursor: pointer;
        }
        .scoreboard td.selectable:hover {
            background-color: #e0e0e0;
        }
        .scoreboard td.scored {
            background-color: #d3d3d3;
            cursor: not-allowed;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Room: {{ room_name }}</h1>
    <div id="ws-status" style="background-color: yellow; padding: 5px;">WebSocket Status: Connecting...</div>

    <div>
        <h2>Game State</h2>
        <div id="current-player-turn">It's Player 1's turn.</div>
        <div id="rolls-left">Rolls Left: 3</div>
        <div class="dice-container" id="dice-display">
            <!-- Dice will be injected here by JavaScript -->
        </div>
        <button id="roll-dice-button">Roll Dice</button>
        <div id="game-over-message" style="color: red; font-weight: bold; display: none;">GAME OVER!</div>
    </div>

    <hr>

    <div>
        <h2>Scoreboard</h2>
        <table class="scoreboard">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Score</th>
                    <th>Potential</th>
                </tr>
            </thead>
            <tbody id="scoreboard-body">
                <!-- Score rows will be injected here by JavaScript -->
            </tbody>
            <tfoot>
                <tr>
                    <td>Bonus</td>
                    <td id="bonus-score">0</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Total</td>
                    <td id="total-score">0</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <hr>

    <h2>Chat</h2>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send">

    {{ room_name|json_script:"room-name" }}
    {{ score_categories|json_script:"score-categories" }}
    {{ user_id|json_script:"current-user-id" }}

    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const scoreCategories = JSON.parse(document.getElementById('score-categories').textContent);
        const currentUserId = JSON.parse(document.getElementById('current-user-id').textContent);
        
        const diceDisplay = document.getElementById('dice-display');
        const rollDiceButton = document.getElementById('roll-dice-button');
        const rollsLeftDisplay = document.getElementById('rolls-left');
        const scoreboardBody = document.getElementById('scoreboard-body');
        const bonusScoreDisplay = document.getElementById('bonus-score');
        const totalScoreDisplay = document.getElementById('total-score');
        const gameOverMessage = document.getElementById('game-over-message');
        const currentPlayerTurnDisplay = document.getElementById('current-player-turn');
        
        let currentDice = [1, 1, 1, 1, 1];
        let keptDiceIndices = [];
        let currentScores = {};
        let currentPotentialScores = {};
        let currentRollsLeft = 3;
        let isGameOver = false;
        let currentTurnPlayerId = null;

        const wsStatusDisplay = document.getElementById('ws-status');

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/game/'
            + roomName
            + '/'
        );

        chatSocket.onopen = function(e) {
            wsStatusDisplay.textContent = "WebSocket Status: Connected";
            wsStatusDisplay.style.backgroundColor = "lightgreen";
            console.log("WebSocket connection established");
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'chat') {
                document.querySelector('#chat-log').value += (data.message + '\n');
            } else if (data.type === 'game_state') {
                console.log("Game State Received:", data.state);
                document.querySelector('#chat-log').value += ("Game State Update: Round " + data.state.round + "\n");
                
                // Update UI with new game state
                currentDice = data.state.dice;
                currentRollsLeft = data.state.rolls_left;
                currentScores = data.state.scores;
                currentPotentialScores = data.potential_scores;
                bonusScoreDisplay.textContent = data.state.bonus_score;
                totalScoreDisplay.textContent = data.state.total_score;
                isGameOver = data.state.game_over;
                currentTurnPlayerId = data.current_turn_player_id; 

                rollsLeftDisplay.textContent = `Rolls Left: ${currentRollsLeft}`;
                
                let turnText = "";
                if (currentTurnPlayerId === currentUserId) {
                    turnText = "It's YOUR turn.";
                    document.body.style.backgroundColor = "#e6ffe6"; // Light green for your turn
                } else {
                    turnText = "It's Opponent's turn.";
                    document.body.style.backgroundColor = "#fff0f0"; // Light red for opponent
                }
                currentPlayerTurnDisplay.textContent = turnText;

                updateDiceDisplay();
                updateScoreboardDisplay();
                updateGameControls();
                
                if (currentRollsLeft === 3 && keptDiceIndices.length > 0) { 
                    keptDiceIndices = []; 
                    updateDiceDisplay(); 
                }

            } else if (data.type === 'error') {
                alert('Server Error: ' + data.message);
                document.querySelector('#chat-log').value += ("ERROR: " + data.message + '\n');
            }
        };

        chatSocket.onclose = function(e) {
            wsStatusDisplay.textContent = "WebSocket Status: Disconnected (Code: " + e.code + ")";
            wsStatusDisplay.style.backgroundColor = "salmon";
            console.error('Chat socket closed unexpectedly', e);
            alert("WebSocket connection closed. Please refresh the page.");
        };

        chatSocket.onerror = function(e) {
             wsStatusDisplay.textContent = "WebSocket Status: Error";
             wsStatusDisplay.style.backgroundColor = "red";
             console.error('WebSocket error observed:', e);
        };

        function updateDiceDisplay() {
            diceDisplay.innerHTML = ''; // Clear existing dice
            currentDice.forEach((value, index) => {
                const diceDiv = document.createElement('div');
                diceDiv.classList.add('dice');
                if (keptDiceIndices.includes(index)) {
                    diceDiv.classList.add('kept');
                }
                // Disable dice keeping if no rolls left, game over, or not current user's turn
                if (currentRollsLeft === 0 || isGameOver || currentTurnPlayerId !== currentUserId) {
                    diceDiv.classList.add('disabled');
                } else {
                    diceDiv.addEventListener('click', () => toggleKeepDice(index));
                }
                diceDiv.dataset.index = index;
                diceDiv.textContent = value;
                diceDisplay.appendChild(diceDiv);
            });
        }

        function toggleKeepDice(index) {
            // Only allow toggling if rolls are left and game is not over and it's current user's turn
            if (currentRollsLeft > 0 && !isGameOver && currentTurnPlayerId === currentUserId) {
                const diceIndex = keptDiceIndices.indexOf(index);
                if (diceIndex > -1) {
                    keptDiceIndices.splice(diceIndex, 1); // Remove from kept
                } else {
                    keptDiceIndices.push(index); // Add to kept
                }
                updateDiceDisplay(); // Re-render to update UI
            }
        }

        rollDiceButton.onclick = function() {
            if (currentRollsLeft > 0 && !isGameOver && currentTurnPlayerId === currentUserId) {
                chatSocket.send(JSON.stringify({
                    'action': 'roll',
                    'keep_indices': keptDiceIndices
                }));
            }
        };

        function updateScoreboardDisplay() {
            scoreboardBody.innerHTML = '';
            scoreCategories.forEach(category => {
                const row = document.createElement('tr');
                const scoredValue = currentScores[category];
                const potentialValue = currentPotentialScores[category] !== undefined ? currentPotentialScores[category] : '';

                row.innerHTML = `
                    <td>${category}</td>
                    <td>${scoredValue !== null ? scoredValue : '-'}</td>
                    <td id="potential-${category.replace(/\s/g, '-')}" class="${scoredValue === null ? 'selectable' : 'scored'}" data-category="${category}">${potentialValue}</td>
                `;
                
                const potentialCell = row.querySelector(`td[data-category="${category}"]`);
                // Only allow selecting if not scored, game not over, and it's current user's turn
                if (scoredValue === null && !isGameOver && currentTurnPlayerId === currentUserId) {
                    potentialCell.addEventListener('click', () => selectScore(category));
                } else {
                    potentialCell.classList.add('disabled'); // Visually indicate not selectable
                }
                scoreboardBody.appendChild(row);
            });
        }

        function selectScore(category) {
            // Only allow selecting if game is not over and it's current user's turn
            if (!isGameOver && currentTurnPlayerId === currentUserId) {
                chatSocket.send(JSON.stringify({
                    'action': 'select_score',
                    'category': category
                }));
            }
        }

        function updateGameControls() {
            // Roll button disabled if no rolls left, game over, or not user's turn
            rollDiceButton.disabled = (currentRollsLeft === 0 || isGameOver || currentTurnPlayerId !== currentUserId);

            if (isGameOver) {
                gameOverMessage.style.display = 'block';
            } else {
                gameOverMessage.style.display = 'none';
            }
        }

        // Initial display setup
        updateDiceDisplay();
        updateScoreboardDisplay();
        updateGameControls();

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
    </script>
</body>
</html>